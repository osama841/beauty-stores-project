# Laravel Policies Implementation - Beauty Store Project

## نظرة عامة

تم تطبيق نظام Laravel Policies لحماية الوصول إلى الموارد في مشروع متجر الجمال. هذا النظام يضمن أن المستخدمين يمكنهم فقط الوصول إلى الموارد التي يملكونها أو لديهم صلاحية للوصول إليها.

## السياسات المطبقة

### 1. UserPolicy
- **الوصول**: المستخدم يمكنه عرض وتعديل ملفه الشخصي فقط
- **المشرفون**: يمكنهم الوصول لجميع الملفات الشخصية
- **الحذف**: المشرفون فقط يمكنهم حذف المستخدمين

### 2. OrderPolicy
- **الوصول**: المستخدم يمكنه عرض طلباته الخاصة فقط
- **الإنشاء**: أي مستخدم مصادق يمكنه إنشاء طلبات
- **التعديل**: المشرفون فقط يمكنهم تعديل الطلبات
- **الحذف**: المشرفون فقط يمكنهم حذف الطلبات

### 3. ReviewPolicy
- **الوصول**: المستخدم يمكنه عرض مراجعاته الخاصة والمراجعات المعتمدة
- **الإنشاء**: أي مستخدم مصادق يمكنه إنشاء مراجعات
- **التعديل**: المستخدم يمكنه تعديل مراجعاته الخاصة فقط
- **الحذف**: المستخدم يمكنه حذف مراجعاته الخاصة فقط
- **الموافقة**: المشرفون فقط يمكنهم الموافقة على المراجعات

### 4. AddressPolicy
- **الوصول**: المستخدم يمكنه عرض عناوينه الخاصة فقط
- **الإنشاء**: أي مستخدم مصادق يمكنه إنشاء عناوين
- **التعديل**: المستخدم يمكنه تعديل عناوينه الخاصة فقط
- **الحذف**: المستخدم يمكنه حذف عناوينه الخاصة فقط

### 5. ShoppingCartPolicy
- **الوصول**: المستخدم يمكنه عرض سلته الخاصة فقط
- **الإنشاء**: أي مستخدم مصادق يمكنه إضافة منتجات لسلته
- **التعديل**: المستخدم يمكنه تعديل سلته الخاصة فقط
- **الحذف**: المستخدم يمكنه حذف عناصر من سلته الخاصة فقط

### 6. PaymentPolicy
- **الوصول**: المستخدم يمكنه عرض مدفوعاته الخاصة فقط
- **الإنشاء**: أي مستخدم مصادق يمكنه إنشاء مدفوعات
- **التعديل**: المستخدم يمكنه تعديل مدفوعاته غير المكتملة فقط
- **الحذف**: المستخدم يمكنه حذف مدفوعاته غير المكتملة فقط
- **الإلغاء**: المستخدم يمكنه إلغاء مدفوعاته المعلقة فقط

### 7. OrderItemPolicy
- **الوصول**: المستخدم يمكنه عرض عناصر طلباته فقط
- **الإنشاء**: أي مستخدم مصادق يمكنه إنشاء عناصر طلب
- **التعديل**: المستخدم يمكنه تعديل عناصر طلباته غير المكتملة فقط
- **الحذف**: المستخدم يمكنه حذف عناصر طلباته غير المكتملة فقط

## المتحكمات المحدثة

### 1. UserController
- يستخدم `authorizeResource(User::class, 'user')`
- يطبق السياسات تلقائياً على جميع العمليات

### 2. OrderController
- يستخدم `authorizeResource(Order::class, 'order')`
- يطبق السياسات تلقائياً على جميع العمليات

### 3. ReviewController
- يستخدم `authorizeResource(Review::class, 'review')`
- يضيف `authorize()` يدوياً للعمليات الخاصة

### 4. AddressController
- يستخدم `authorizeResource(Address::class, 'address')`
- يطبق السياسات تلقائياً على جميع العمليات

### 5. ShoppingCartController
- يستخدم `authorizeResource(ShoppingCart::class, 'shoppingCart')`
- يضيف `authorize()` يدوياً للعمليات الخاصة

### 6. PaymentController
- يستخدم `authorizeResource(Payment::class, 'payment')`
- يضيف `authorize()` يدوياً للعمليات الخاصة

### 7. OrderItemController
- يستخدم `authorizeResource(OrderItem::class, 'orderItem')`
- يطبق السياسات تلقائياً على جميع العمليات

## الواجهة الأمامية (React)

### 1. مكونات الحماية
- **PermissionGuard**: مكون لحماية الواجهات بناءً على الصلاحيات
- **ErrorHandler**: مكون للتعامل مع أخطاء API
- **ActionButtons**: مكون لأزرار الإجراءات التي تظهر بناءً على الصلاحيات

### 2. معالجة الأخطاء
- تم إضافة معالج للاستجابات في `axiosInstance.js`
- التعامل مع أخطاء 401 (غير مصادق) و 403 (غير مصرح)
- إعادة توجيه تلقائي لصفحة تسجيل الدخول عند انتهاء صلاحية الجلسة

### 3. أزرار الإجراءات
- **ActionButtons**: أزرار عامة للتعديل والحذف والعرض
- **ReviewActionButtons**: أزرار خاصة بالمراجعات (تعديل، حذف، موافقة)
- **OrderActionButtons**: أزرار خاصة بالطلبات (عرض، إلغاء، تحديث الحالة)

## كيفية الاستخدام

### في Laravel (Backend)

```php
// في المتحكم
public function __construct()
{
    $this->authorizeResource(Model::class, 'model');
}

// أو يدوياً
public function store(Request $request)
{
    $this->authorize('create', Model::class);
    // ... باقي الكود
}
```

### في React (Frontend)

```jsx
// حماية واجهة
<PermissionGuard
  requireAuth={true}
  resource="order"
  action="edit"
  resourceData={order}
>
  <EditOrderForm order={order} />
</PermissionGuard>

// أزرار الإجراءات
<ActionButtons
  resource="review"
  resourceData={review}
  onEdit={handleEdit}
  onDelete={handleDelete}
/>

// معالجة الأخطاء
<ErrorHandler error={error} onRetry={handleRetry} />
```

## الفوائد

1. **الأمان**: حماية شاملة للموارد من الوصول غير المصرح
2. **المرونة**: سهولة إضافة صلاحيات جديدة أو تعديل الموجودة
3. **التناسق**: تطبيق موحد للصلاحيات في جميع أنحاء التطبيق
4. **تجربة المستخدم**: إخفاء الأزرار والواجهات التي لا يمكن الوصول إليها
5. **الصيانة**: سهولة الصيانة والتطوير المستقبلي

## الاختبار

يجب اختبار جميع السياسات للتأكد من:
- المستخدمين العاديين يمكنهم الوصول لمواردهم فقط
- المشرفون يمكنهم الوصول لجميع الموارد
- الأخطاء تظهر بشكل مناسب عند محاولة الوصول غير المصرح
- الواجهة الأمامية تعرض الأزرار المناسبة فقط 